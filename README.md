## **ğŸ¬Â  í•˜ë£¨í•„ë¦„ ì„œë¹„ìŠ¤ ì†Œê°œ**

**Haru Film**ì€ ì¼ìƒì˜ ì†Œì¤‘í•œ ìˆœê°„ë“¤ì„ ë§¤ì¼ ê¸°ë¡í•˜ê³  ê³µìœ í•˜ëŠ” $\bf{\color{#E53935}ì¼ì¼\ ì˜ìƒ\ ì¼ê¸°\ ìŠ¤íŠ¸ë¦¬ë°\ í”Œë«í¼}$ ì…ë‹ˆë‹¤.
- ğŸ¥Â **í•˜ë£¨ 1ê°œ ë¹„ë””ì˜¤ ì—…ë¡œë“œ**
- ğŸï¸Â **ìë™ ì¸ì½”ë”©**
- ğŸ“…Â **ì‹œê°„ ê¸°ë°˜ íƒ€ì„ìŠ¤íƒ¬í”„**
- ğŸ“¸Â **ì¸ë„¤ì¼ ìƒì„±**
- ğŸ””Â **í‘¸ì‹œ ì•Œë¦¼**
- ğŸ”Â **Google OAuth**

<details>

<summary><h3>1. ë¹„ë””ì˜¤ ì—…ë¡œë“œ</h3></summary>

- **ë©€í‹°íŒŒíŠ¸ ì—…ë¡œë“œ**: ëŒ€ìš©ëŸ‰ íŒŒì¼ë„ ì•ˆì •ì ìœ¼ë¡œ ì—…ë¡œë“œ
- **Presigned URL ì‚¬ìš©**: í´ë¼ì´ì–¸íŠ¸ê°€ S3ì— ì§ì ‘ ì—…ë¡œë“œ (ì„œë²„ ë¶€í•˜ ê°ì†Œ)
- **ì²­í¬ ê¸°ë°˜ ì „ì†¡**: ë„¤íŠ¸ì›Œí¬ ë¶ˆì•ˆì •í•´ë„ ì—…ë¡œë“œ ì¬ê°œ ê°€ëŠ¥
- **ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìë™ ë¡¤ë°±**: ë¶€ë¶„ ë°ì´í„° ìë™ ì •ë¦¬

</details>

<details>

<summary><h3>2. ë¹„ë””ì˜¤ ì¸ì½”ë”© (ë°±ê·¸ë¼ìš´ë“œ)</h3></summary>

- **FFmpeg ê¸°ë°˜ ìë™ ë³€í™˜**: H.264 ì½”ë±ìœ¼ë¡œ ìµœì í™”
- **HLS ìŠ¤íŠ¸ë¦¬ë° í¬ë§·**: ë‹¤ì–‘í•œ í•´ìƒë„ ìë™ ìƒì„±
    - 360p (ì €í™”ì§ˆ, ë¹ ë¥¸ ë¡œë”©)
    - 720p (ì¤‘í™”ì§ˆ, ê· í˜•)
    - 1080p (ê³ í™”ì§ˆ, ìµœê³  í’ˆì§ˆ)
- **ë¹„ë™ê¸° ì²˜ë¦¬**: ì¸ì½”ë”© ì¤‘ ë‹¤ë¥¸ ì‘ì—… ê°€ëŠ¥
- **ìë™ ì •ë¦¬**: ì¸ì½”ë”© ì™„ë£Œ í›„ ì„ì‹œ íŒŒì¼ ìë™ ì‚­ì œ

</details>

<details>

<summary><h3>3. ë¹„ë””ì˜¤ ì¡°íšŒ</h3></summary>

- **ì›”ë³„ ì¡°íšŒ**: íŠ¹ì • ì›”ì˜ ëª¨ë“  ë¹„ë””ì˜¤ ì¡°íšŒ
- **ì˜¤ëŠ˜ì˜ í”¼ë“œ**: ì˜¤ëŠ˜ ì—…ë¡œë“œëœ ë¹„ë””ì˜¤ ì¡°íšŒ
- **íŠ¹ì • ë‚ ì§œ ì¡°íšŒ**: íŠ¹ì • ë‚ ì§œì˜ ë¹„ë””ì˜¤ + íƒ€ì„ìŠ¤íƒí”„ ì¡°íšŒ
- **ê²€ìƒ‰**: ì—…ë¡œë“œ ë‚ ì§œ, ìƒíƒœ ë“±ìœ¼ë¡œ í•„í„°ë§

</details>

<details>

<summary><h3>4. í‘¸ì‹œ ì•Œë¦¼ (FCM)</h3></summary>

- **ì—…ë¡œë“œ ì•Œë¦¼**: "ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
- **ì¸ì½”ë”© ì™„ë£Œ ì•Œë¦¼**: "ë¹„ë””ì˜¤ ì¸ì½”ë”©ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
- **ì˜ìƒ ì—…ë¡œë“œ ë¦¬ë§ˆì¸ë“œ ì•Œë¦¼**: "ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ê¸°ë¡í•˜ì„¸ìš”!"
- **í† í° ê´€ë¦¬**: ê¸°ê¸°ë³„ ê³ ìœ  FCM í† í°ìœ¼ë¡œ ê°œì¸í™” ì•Œë¦¼

</details>

## **ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜**

<img src="/uploads/0b9d421c98b7de5c5d750eb52cec1f53/image.png"/>

## **ğŸ“ ë²¡ì—”ë“œ ì•„í‚¤í…ì²˜**

- **ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜**:Â API ì„œë²„ì™€ Encoding ì„œë²„ ë¶„ë¦¬
- **ë¹„ë™ê¸° ì²˜ë¦¬**:Â RabbitMQë¥¼ í†µí•œ ë©”ì‹œì§€ ê¸°ë°˜ í†µì‹ 
- **ì˜ì¡´ì„± ì£¼ì…**:Â container.jsë¥¼ í†µí•œ ì¤‘ì•™ DI ê´€ë¦¬
- Router â†’ Controller â†’ Business(ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§) â†’ Service(ìƒì„¸ êµ¬í˜„) â†’ Repository ê³„ì¸µ ë¶„ë¦¬

<details>
<summary><h3>ë””ë ‰í† ë¦¬ êµ¬ì¡°</h3></summary>

```
harufilm-backend/
â”œâ”€â”€ docker-compose.yml          # ë„ì»¤ ì»´í¬ì¦ˆ
â”‚
â”œâ”€â”€ api-server/                 # API ì„œë²„ (Node.js, Express)
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ server.js              # ì„œë²„ ì§„ì…ì 
â”‚   â”œâ”€â”€ prisma/                # DB ìŠ¤í‚¤ë§ˆ
â”‚   â”‚   â””â”€â”€ schema.prisma
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ app.js             # Express ì•± ì„¤ì •
â”‚       â”œâ”€â”€ container.js       # ì˜ì¡´ì„± ì£¼ì… ì»¨í…Œì´ë„ˆ (DI)
â”‚       â”œâ”€â”€ business/          # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê³„ì¸µ
â”‚       â”‚   â”œâ”€â”€ auth.business.js
â”‚       â”‚   â”œâ”€â”€ ...
â”‚       â”‚   â””â”€â”€ video.business.j
â”‚       â”œâ”€â”€ controllers/       # ì»¨íŠ¸ë¡¤ëŸ¬ ê³„ì¸µ (ìš”ì²­ ì²˜ë¦¬)
â”‚       â”‚   â”œâ”€â”€ auth.controller.js
â”‚       â”‚   â”œâ”€â”€ ...
â”‚       â”‚   â””â”€â”€ video.controller.js
â”‚       â”œâ”€â”€ domain/           # ë„ë©”ì¸ ê°ì²´ ë° ì €ì¥ì†Œ ê³„ì¸µ
â”‚       â”‚   â””â”€â”€ repositories/
â”‚       â”‚       â”œâ”€â”€ token.repository.js
â”‚       â”‚       â”œâ”€â”€ ...
â”‚       â”‚       â””â”€â”€ video.repository.js
â”‚       â”œâ”€â”€ middlewares/      # ë¯¸ë“¤ì›¨ì–´
â”‚       â”‚   â”œâ”€â”€ auth.middleware.js (JWT ê²€ì¦)
â”‚       â”‚   â””â”€â”€ error-handler.middleware.js
â”‚       â”œâ”€â”€ routes/           # ë¼ìš°í„° ì •ì˜
â”‚       â”‚   â”œâ”€â”€ auth.router.js
â”‚       â”‚   â”œâ”€â”€ ...
â”‚       â”‚   â””â”€â”€ video.router.js
â”‚       â””â”€â”€ services/         # ì„œë¹„ìŠ¤ ê³„ì¸µ (ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì˜ êµ¬í˜„)
â”‚           â”œâ”€â”€ auth/
â”‚           â”œâ”€â”€ ...
â”‚           â””â”€â”€ video/
â”‚
â””â”€â”€ encoding-server/           # ì˜ìƒ ì¸ì½”ë”© ì›Œì»¤ (Node.js)
    â”œâ”€â”€ Dockerfile
    â””â”€â”€ src/
        â”œâ”€â”€ container.js       # ì˜ì¡´ì„± ì£¼ì…
        â”œâ”€â”€ worker.js
        â”œâ”€â”€ business/
        â”‚   â””â”€â”€ encoding.business.js
        â””â”€â”€ services/
            â”œâ”€â”€ encoding/
            â”œâ”€â”€ rabbitmq/
            â””â”€â”€ s3/
```

</details>

<details>
<summary><h3>ì˜ì¡´ì„± ì£¼ì… (DI Container)</h3></summary>

```javascript
// 1. DB ë° ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸
const s3Client = new S3Client({ region: process.env.AWS_REGION });

// 2. Repository ê³„ì¸µ
const userRepository = new UserRepository(prisma);
const videoRepository = new VideoRepository(prisma);

// 3. Service ê³„ì¸µ (Repository ì˜ì¡´)
const authService = new AuthService();
const s3Service = new S3Service(s3Client, s3BucketName);
const userService = new UserService(userRepository);

// 4. Business ê³„ì¸µ (Service ì˜ì¡´)
const authBusiness = new AuthBusiness(authService, userService, tokenService, fcmService);

// 5. Controller ê³„ì¸µ (Business ì˜ì¡´)
const authController = new AuthController(authBusiness);

```

</details>

## **ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ**

<img src="/uploads/878c0fdce7885d2c476059dd6ae9be58/image.png"  width="600" />

## **ğŸ”„Â User Flow (ì‚¬ìš©ì íë¦„)**

<details>
<summary><h3>OAuth Google ì†Œì…œ ë¡œê·¸ì¸ í”Œë¡œìš°</h3></summary>

```mermaid
sequenceDiagram
    participant Client as í´ë¼ì´ì–¸íŠ¸
    participant API as API Server
    participant Google as Google OAuth
    participant DB as MySQL

    Client->>Google: 1. ë¡œê·¸ì¸ ìš”ì²­
    Google-->>Client: 2. ì¸ì¦ í˜ì´ì§€
    Client->>Google: 3. ë¡œê·¸ì¸ ì™„ë£Œ
    Google-->>Client: 4. ì¸ì¦ ì½”ë“œ

    Client->>API: 5. ì½”ë“œ ì „ë‹¬
    API->>Google: 6. í† í° ê²€ì¦
    Google-->>API: 7. ì‚¬ìš©ì ì •ë³´

    API->>DB: 8. ì‚¬ìš©ì ì €ì¥/ì¡°íšŒ
    DB-->>API: 9. ì‚¬ìš©ì ë°ì´í„°

    API->>DB: 10. FCM í† í° ì €ì¥
    API-->>Client: 11. JWT í† í° ë°˜í™˜
```

</details>

### **ë¹„ë””ì˜¤ ì—…ë¡œë“œ ë° ì¸ì½”ë”© í”Œë¡œìš°**

```mermaid
sequenceDiagram
    participant Client as í´ë¼ì´ì–¸íŠ¸
    participant APIServer as API Server
    participant S3 as AWS S3
    participant RabbitMQ as RabbitMQ
    participant EncodingServer as Encoding Server
    participant DB as MySQL DB
    participant Firebase as Firebase FCM
    
    Client->>APIServer: POST /uploads/multi-parts/initiate
    APIServer->>APIServer: Presigned URL ìƒì„±
    APIServer-->>Client: uploadId + URLs
    
    Client->>S3: íŒŒì¼ ì—…ë¡œë“œ (Presigned URL)
    Client->>APIServer: POST /uploads/multi-parts/complete
    APIServer->>DB: Video ë ˆì½”ë“œ ìƒì„± (PENDING)
    APIServer->>RabbitMQ: ì¸ì½”ë”© ì‘ì—… ë©”ì‹œì§€ ë°œí–‰
    APIServer->>Firebase: í‘¸ì‹œ ì•Œë¦¼ ë°œì†¡
    APIServer-->>Client: ì—…ë¡œë“œ ì™„ë£Œ
    Firebase-->>Client: ì•Œë¦¼ ìˆ˜ì‹ 
    
    RabbitMQ->>EncodingServer: ë©”ì‹œì§€ ì†Œë¹„
    EncodingServer->>S3: ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
    EncodingServer->>EncodingServer: FFmpeg ì¸ì½”ë”©
    EncodingServer->>S3: ì¸ì½”ë”©ëœ íŒŒì¼ ì—…ë¡œë“œ
    EncodingServer->>RabbitMQ: ì¸ì½”ë”© ì™„ë£Œ ë©”ì‹œì§€ ë°œí–‰
    
    RabbitMQ->>APIServer: ì™„ë£Œ ë©”ì‹œì§€
    APIServer->>DB: Video ìƒíƒœ ë³€ê²½ (COMPLETE)
    APIServer->>Firebase: í‘¸ì‹œ ì•Œë¦¼ ë°œì†¡
    Firebase-->>Client: ì•Œë¦¼ ìˆ˜ì‹ 
```

### FCM í‘¸ì‹œ ì•Œë¦¼ í”Œë¡œìš°

<img src="/uploads/9a9feee76971276cc9eb26916b75f8da/image.png"  width="600" />

<details>
<summary><b>FCM í‘¸ì‹œ ì•Œë¦¼ í”Œë¡œìš°</b></summary>

```mermaid
sequenceDiagram
    participant Client as í´ë¼ì´ì–¸íŠ¸
    participant API as API Server
    participant DB as MySQL
    participant Scheduler as Scheduler
    participant FCM as Firebase FCM

    Scheduler->>DB: 1. ì¸ì½”ë”© ì™„ë£Œëœ ì˜ìƒ ì¡°íšŒ
    DB-->>Scheduler: 2. ì˜ìƒ ë°ì´í„°

    Scheduler->>DB: 3. FCM í† í° ì¡°íšŒ
    DB-->>Scheduler: 4. í† í° ë°˜í™˜

    Scheduler->>FCM: 5. ì•Œë¦¼ ì „ì†¡
    FCM-->>Scheduler: 6. ì „ì†¡ ì™„ë£Œ

    FCM->>Client: 7. í‘¸ì‹œ ì•Œë¦¼ ë„ì°©
```

</details>

## **ğŸ”§ í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒ**

| **ì¹´í…Œê³ ë¦¬** | **ê¸°ìˆ ** |
| --- | --- |
| **ì›¹ í”„ë ˆì„ì›Œí¬** | Express.js (Node.js) |
| **ORM** | Prisma |
| **ë°ì´í„°ë² ì´ìŠ¤** | MySQL |
| **í´ë¼ìš°ë“œ ì €ì¥ì†Œ** | AWS S3 |
| **ë©”ì‹œì§€ í** | RabbitMQ |
| **ì¸ì¦** | Google OAuth 2.0, JWT |
| **í‘¸ì‹œ ì•Œë¦¼** | Firebase Cloud Messaging (FCM) |
| **ë¹„ë””ì˜¤ ì²˜ë¦¬** | FFmpeg |
| **íŒŒì¼ ì—…ë¡œë“œ** | multer, multer-s3 |
| **ì»¨í…Œì´ë„ˆí™”** | Docker, Docker Compose |

<details>
<summary><h3>API Server ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° ë²„ì „</h3></summary>

| **ë¼ì´ë¸ŒëŸ¬ë¦¬** | **ë²„ì „** | **ìš©ë„** |
| --- | --- | --- |
| **express** | ^5.1.0 | ì›¹ í”„ë ˆì„ì›Œí¬ |
| **@prisma/client** | ^6.18.0 | ORM (DB ì¿¼ë¦¬ ë¹Œë”) |
| **firebase-admin** | ^13.6.0 | Firebase Admin SDK (FCM í‘¸ì‹œ ì•Œë¦¼) |
| **@aws-sdk/client-s3** | ^3.925.0 | AWS S3 í´ë¼ì´ì–¸íŠ¸ |
| **@aws-sdk/s3-request-presigner** | ^3.925.0 | S3 Presigned URL ìƒì„± |
| **amqplib** | ^0.10.9 | RabbitMQ í´ë¼ì´ì–¸íŠ¸ |
| **jsonwebtoken** | ^9.0.2 | JWT í† í° ìƒì„±/ê²€ì¦ |
| **node-schedule** | ^2.1.1 | ìŠ¤ì¼€ì¤„ëŸ¬ (ì •ê¸°ì ì¸ ì‘ì—…) |
| **cookie-parser** | ^1.4.7 | ì¿ í‚¤ íŒŒì‹± |
| **cors** | ^2.8.5 | CORS ì²˜ë¦¬ |
| **dotenv** | ^17.2.3 | í™˜ê²½ë³€ìˆ˜ ë¡œë“œ |

</details>

<details>
<summary><h3>Encoding Server ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° ë²„ì „</h3></summary>

| **ë¼ì´ë¸ŒëŸ¬ë¦¬** | **ë²„ì „** | **ìš©ë„** |
| --- | --- | --- |
| **@ffmpeg-installer/ffmpeg** | ^1.1.0 | FFmpeg ë°”ì´ë„ˆë¦¬ (ë¹„ë””ì˜¤ ì¸ì½”ë”©) |
| **multer** | ^2.0.2 | íŒŒì¼ ì—…ë¡œë“œ ë¯¸ë“¤ì›¨ì–´ |
| **multer-s3** | ^3.0.1 | S3ì— ì§ì ‘ ì—…ë¡œë“œ |
| **amqplib** | ^0.10.9 | RabbitMQ í´ë¼ì´ì–¸íŠ¸ |
| **@aws-sdk/client-s3** | ^3.925.0 | AWS S3 í´ë¼ì´ì–¸íŠ¸ |
| **@aws-sdk/s3-request-presigner** | ^3.925.0 | S3 Presigned URL |
| **dotenv** | ^17.2.3 | í™˜ê²½ë³€ìˆ˜ ë¡œë“œ |

</details>